
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
    font-family: -apple-system;
    font-size: 1em;
    margin: 1em;
}
.container {
    margin-top: 1em;
}
</style>
<h1>Recent examples</h1>
<script>

let apiRoot = "https://api.github.com";
let username = "whsieh";
let repository = "whsieh.github.io";
let urlRoot = "https://whsieh.github.io";
let examplesDirectoryName = "examples";
let fetchedExamplePages = new Set();
let validExamplePageNames = new Set();

function fetchJSONFromURL(url, completion) {
    fetch(url)
        .then(data => data.text())
        .then(text => completion(JSON.parse(text)));
}

function getLatestCommit(commitInfos)
{
    let latestCommitInfo = null;
    let timestampOfLatestCommit = 0;
    for (let commitInfo of commitInfos) {
        let timestamp = new Date(commitInfo.commit.author.date).getTime();
        if (timestamp <= timestampOfLatestCommit)
            continue;

        timestampOfLatestCommit = timestamp;
        latestCommitInfo = commitInfo;
    }
    return latestCommitInfo;
}

function recursivelyUpdateRecentPagesForCommits(commitInfos, limit, delay)
{
    if (!limit)
        return;

    let latestCommitInfo = getLatestCommit(commitInfos);
    commitInfos.splice(commitInfos.indexOf(latestCommitInfo), 1);
    fetchJSONFromURL(`${apiRoot}/repos/${username}/${repository}/commits/${latestCommitInfo.sha}`, (commitDetail) => {
        for (let changedFile of commitDetail.files.map(fileInfo => fileInfo.filename)) {
            if (fetchedExamplePages.has(changedFile) || !changedFile.match(/^examples\/.*.html$/) || !validExamplePageNames.has(changedFile))
                continue;

            fetchedExamplePages.add(changedFile);
            let link = document.createElement("a");
            link.href = `${urlRoot}/${changedFile}`;
            link.textContent = link.href;
            let container = document.createElement("div");
            container.appendChild(link);
            container.className = "container";
            document.body.appendChild(container);
        }

        setTimeout(() => {
            recursivelyUpdateRecentPagesForCommits(commitInfos, limit - 1);
        }, delay);
    })
}

(() => {
    fetchJSONFromURL(`${apiRoot}/repos/${username}/${repository}/contents/${examplesDirectoryName}?ref=master`, examples => {
        validExamplePageNames = new Set(examples.map(exampleInfo => exampleInfo.path));
        fetchJSONFromURL(`${apiRoot}/repos/${username}/${repository}/commits`, commitInfos => recursivelyUpdateRecentPagesForCommits(commitInfos, 10, 500));
    });
})();

</script>
